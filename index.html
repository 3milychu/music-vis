<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link href="https://fonts.googleapis.com/css?family=Overpass:200,300,400,600,800" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Heebo:100,300,400" rel="stylesheet">
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="styles.css">
	<script src="https://cdn.jsdelivr.net/npm/vue"></script>
	<meta name="viewport" content="width=device-width">
</head>
<body>
<!-- audio -->
<div class="fill">
</div>
<header>
	<div class="filters">
		<div class="option zoom" name="zoom" value="dynamic">Dynamic View</div>
		<div class="option zoom" name="zoom" value="locked">Locked View</div>
	</div>
	<div class="filters">
		<div class="option playback" name="playback" value="experienced">Experienced time</div>
		<div class="option playback" name="playback" value="real">Real time</div>
	</div>

	<div id="perspective-filter">
		<i class="material-icons">remove_red_eye</i>
	</div>

	<div class="people-filters">
		<option name="all" value="all" style="background-color:#1A1A1A;color:white">Everyone</option>
		<div class="filters" id=people-filter-1>
			<h1>Performers</h1>
			<option name="performers" value="both">Both</option>
			<option name="performers" value="locked">Pianist Only</option>
			<option name="performers" value="locked">Cellist Only</option>
		</div>
		<div class="filters" id=people-filter-1>
			<h1>Audience</h1>
			<option name="audience" value="dynamic">All</option>
			<option name="audience" value="locked">Heard Only</option>
			<option name="audience" value="locked">Played Only</option>
		</div>
		<div class="filters" id=people-filter-1>
			<h1>Backup</h1>
			<option name="backup" value="dynamic">Both</option>
			<option name="backup" value="locked">Pianist Only</option>
			<option name="backup" value="locked">Cellist Only</option>
		</div>
	</div>

	<audio controls>
	  <source src="assets/music.wav" type="audio/wav">
	</audio>
		<input value="10"></input>
</header>

<!-- score page-->
<div class="page" id="page1">
</div>

<!-- reactions -->
<div class="view">

	<!-- comments -->
	<div id="reactions">
		<div id="start-message">
			<h1>Notes on Perspective</h1>
			<div class="button" id="play">Play</div>
		</div>
	</div>
	<!-- spatial -->
	<div id="reactions2">
		<div id="hall">
			<div class="performers">
				<div class="person performer" id="performing_pianist"></div>
				<div class="person performer" id="performing_cellist"></div>
			</div>
			<div class="audience">
				<div class="person member" id="class_member_1"></div>
				<div class="person member" id="class_member_2"></div>
				<div class="person member" id="class_member_3"></div>
				<div class="person member" id="class_member_4"></div>
				<div class="person member" id="class_member_5"></div>
				<div class="person member" id="class_member_6"></div>
				<div class="person member" id="class_member_7"></div>
				<div class="person member" id="class_member_8"></div>
				<div class="person member" id="class_member_9"></div>
				<div class="person member" id="class_member_10"></div>
				<div class="person member" id="class_member_11"></div>
				<div class="person member" id="class_member_12"></div>
				<div class="person member" id="class_member_13"></div>
				<div class="person member" id="class_member_14"></div>
			</div>
			<div class="backups">
				<div class="person backup" id="non-performing_pianist"></div>
				<div class="person backup" id="non-performing_cellist"></div>
			</div>
		</div>
	</div>
	<!-- signature -->
	<div id="reactions3">
   			 <div id="canvas"></div>
	</div>


</div>

<!-- vis perspective -->
<div class="perspective">
		<div class="option" id="spatial">
			<div class="label">Spatial View</div>
			<div class="circle-button">
				<i class="material-icons">flare</i>
			</div>
		</div>
		<div class="option" id="comments">
			<div class="label">Comments View</div>
			<div class="circle-button">
				<i class="material-icons">chat_bubble_outline</i>
			</div>
		</div>
		<div class="option" id="signature">
			<div class="label">Signature View</div>
			<div class="circle-button">
				<i class="material-icons">fingerprint</i>
			</div>
		</div>

		<div class="floater">
			<a href="https://en.wikipedia.org/wiki/Fantasy_Pieces_for_Clarinet_and_Piano_(Schumann)" target="_blank">
				<div id="app-name">
					Fantasiest√ºcke, Op.73 (Schumann, Robert)
				</div>
			</a>
		</div>
</div>

<!-- view tooltip -->
<div class="tooltip"></div>

</body>
<!-- <script type="text/javascript" src="computed.js"></script> -->
<script>
var formatTime = d3.format(",.2f");
var music = document.querySelector('audio');
var time;
var view;
var audio;
var measure;
var beat;
var ref = document.querySelector('input');
var watch = "same";
var time_option;
var zoom_option;


//mobile view
if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
    page=document.querySelectorAll('.page');
    for(i=0;i<page.length;i++){
    	page[i].style.height="120vh";
    }
};

// run functions
window.onload=function() {
	spatial();
}
getScore();
d3.csv('data/timestamps.csv')
	.then(function(data) {
		getMusic(data);
	})
	.catch(function(error){
	})

function loadReactions() {
	d3.json('https://raw.githubusercontent.com/3milychu/music-vis/master/data/moment_all.json')
	.then(function(data){
		getReactions(data);
		endorsementsDetail(data);
	})
	.catch(function(error){

	})
}
resizeInterface();
window.onresize=function() {
	resizeInterface();
}
optionsListen("playback");
document.querySelector('.option[value="real"]').click();
optionsListen("zoom");
document.querySelector('.option[value="dynamic"]').click();
status();
document.querySelector('#comments').click();
menuListen();
drawCircles(18);

// play on audio click
audio = document.querySelector('audio');
audio.onclick=function() {
	clear();
}

audio.onpause=function(){
	stopSpin();
}
// play on play button click
play = document.querySelector('.button');
play.onclick=function() {
	clear();
	audio.play();
	
}

audio.onplay=function() {
	perspective = document.querySelector('.perspective');
	perspective.style.backgroundColor="white";
	labels = document.querySelectorAll('.label');
	for(i=0;i<labels.length;i++){
		labels[i].style.color="black";
	}
}

// clear reactions container
function clear() {
	console.log("clear")
	removeStartMessage();
	clearSignature();
}

// remove start message
function removeStartMessage() {
	if(time!=0.00){
		target=document.querySelector('#reactions');
		target.innerHTML="";
		target.style.paddingBottom="70vh";
	}
}

// clear signature
function clearSignature() {
	d3.selectAll('path').remove();
	d3.selectAll('circle')
		.attr("fill", "#1A1A1A")
		.attr("class", "")
		.attr("r", 10);
}

// load music
function getMusic(data) {
	setInterval(function () {
		time = formatTime(music.currentTime);
		console.log(time);
		filter = data.filter(function(d){
	    	return (formatTime(d.timestamp).indexOf(time) == 0);
		 })
		if(filter.length==1){
			roll(filter[0]);
			console.log(time, formatTime(filter[0]['timestamp']))
		} 
		if(time==0.00 || time==221.59){
			stopSpin();
		}
	}, 0);
}

// cameras: roll music and show
function roll(data) {
	reset();
	label = data['img'];
	hover(label);
	scrollTo(label);
	getRef(data);
	spin();
}

// spin and stop record player in signature view
function spin(){
	record = document.querySelector('svg');
	record.classList.add("spin");
}

function stopSpin(){
	record = document.querySelector('svg');
	record.classList.remove("spin");
}


// get where we are in music/data at all times there is some data
function getRef(data){
	measure = data['measure'];
	beat = data['beat'];
	if(ref.value!=measure+beat) {
		ref.value= measure+beat;
		watch = "changed";
		loadReactions();
		} else {
		watch ="same"
	}
}

// people filters menu
function menuListen(){
	menu = document.querySelector('#perspective-filter');
	people_options = document.querySelector('.people-filters');
	
	var toggle = function (a, b) {
	    var togg = false;
	    return function () {
	        // passes return value back to caller
	        return (togg = !togg) ? a() : b();
	    };
	};
	menu.addEventListener('click', toggle(function () {
	    people_options.style.display="block";
	}, function () { 
		people_options.style.display="none";
	}));
}

// time navigation options listen
function optionsListen(name) {
	options=document.querySelectorAll("div[name="+name+"]");
	for(i=0;i<options.length;i++){
		options[i].onclick=function(){
			// this.style.background="linear-gradient(360deg, #AF917F, #E8B586)";
			this.style.backgroundColor="#b5b3b3";
			this.style.color="white";
			if(this.innerHTML=="Experienced time"){
				time_option = "experienced";
				modify = document.querySelector('div[value=real]');
			}else if(this.innerHTML=="Real time") {
				time_option = "real";
				modify = document.querySelector('div[value=experienced]');
			} else if(this.innerHTML=="Dynamic View"){
				zoom_option= "dynamic";
				modify = document.querySelector('div[value=locked]');
			} else if (this.innerHTML=="Locked View"){
				zoom_option="locked";
				modify = document.querySelector('div[value=dynamic');
			}
			modify.style.removeProperty('background');
			modify.style.backgroundColor="transparent";
			modify.style.color="#666666";
			console.log(this.innerHTML);
			console.log(time_option);
			console.log(zoom_option);
		}
	}
}

// capitalize first letter
function caps(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

// get selections
status = [];
function status() {
	perspective = document.querySelector('.perspective');
	p_options = perspective.querySelectorAll('.option');
	for (i=0;i<p_options.length;i++){
		p_options[i].onclick=function() {
			for(j=0;j<p_options.length;j++){
				modify = p_options[j].querySelector('.circle-button');
				modify.style.backgroundColor="#F2F2F2";
				modify.style.color="black";
				modify.style.transform="scale(0.7)";
			}
			// change color
			target = document.getElementById(this.id);
			target = target.querySelector('.circle-button');
			target.style.transform="scale(1)";
			target.style.backgroundColor="#169FFF";
			target.style.color="white";
			// change var view
			view = this.id;
			getView(view);
		}
	}
}

// get dataset view: 0= comments; 2=spatial, 3=signature
function getView(view){
	view_container = document.querySelector('.view');
	if(view == "comments"){
		document.querySelector('#reactions').style.display="inline-block";
		document.querySelector('#reactions2').style.display="none";
		document.querySelector('#reactions3').style.display="none";
		view_container.style.backgroundColor="white";
	} else if (view == "spatial") {
		document.querySelector('#reactions').style.display="none";
		document.querySelector('#reactions2').style.display="inline-block";
		document.querySelector('#reactions3').style.display="none";
		view_container.style.backgroundColor="white";
	} else if (view == "signature") {
		document.querySelector('#reactions').style.display="none";
		document.querySelector('#reactions2').style.display="none";
		document.querySelector('#reactions3').style.display="inline-block";
		view_container.style.backgroundColor="#1A1A1A";
	}

}



// get reactions
function getReactions(data){
	// display reactions
	clear();
	add= data.filter(function(d){
	return ((parseInt(d.MOM_STARTBAR+d.MOM_STARTBEAT) <= ref.value) && (parseInt(d.MOM_ENDBAR+d.MOM_ENDBEAT) >= ref.value));
	 })
	// add stuff
	addComments(add);
	// adjust playback rate
	setExperienceOptions(add);
}

// add reactions to comments view, spatial view and signature view
function addComments(add) {
	if(add.length!=0){
		for (i=0;i<add.length;i++){
			info = add[i];
			id = info['comment_id'];
			comment = info['MOM1CHAR'];
			role = info['role'];
			test = document.getElementById(id);
			if(test==null|test==undefined){
				createComment(info,id,role)
				displayEndorsement(info, id);
				displayTags(info, id);
				updateSpatial(info, role);
				getSignature(info, role)
			}
		}
	}
}

// draw signatures
function getSignature(data, role){
	sentiment = data['sentiment'];
	var point1 = getGraphableId(role);
	var point2 = getGraphableId(data['rater1'])
	var point3 = getGraphableId(data['rater2'])
	
	if(data['rater1_reassigned']>=3){
		console.log(point1, point2)
		if(sentiment == "pos"){
			drawPath(point1, point2, "sig_pos");
		} else {
			drawPath(point1, point2, "sig_neg");
		}
	} else {
		if(sentiment == "pos"){
			highlight(point2, "usig_neg")
		} else {
			highlight(point2, "usig_pos")
		}
	}
	if(data['rater2_reassigned']>=3){
		console.log(point1, point3)
		if(sentiment == "pos"){
			drawPath(point1, point3, "sig_pos");
		} else {
			drawPath(point1, point3, "sig_neg");
		}
	} else {
		if(sentiment == "pos"){
			highlight(point3, "usig_neg")
		} else {
			highlight(point3, "usig_pos")
		}
	}
	if(data['rater1_reassigned']<3 && data['rater2_reassigned']<3){
		if(sentiment=="pos"){
			highlight(point1, "usig_pos");
			highlight(point2, "usig_neg");
			highlight(point3, "usig_neg");
		} 
		if(sentiment=="neg"){
			highlight(point1, "usig_neg");
			highlight(point2, "usig_pos");
			highlight(point3, "usig_pos");
		} 
	}

}


function getGraphableId(name){
	// sig_ref = parseInt(name.slice(-1));
	sig_ref = parseInt(name.slice(-2));
	test = Number.isInteger(sig_ref);
	if(test==true){
			console.log(sig_ref)
			return "person"+sig_ref;

	} else if (test==false){
		if(name=="Performing pianist"){
			return "person15";
		}
		if(name=="Performing cellist"){
			return "person16";
		}
		if(name=="Non-performing pianist"){
			return "person17";
		}
		if(name=="Non-performing cellist"){
			return "person18";
		}
	}
}

function setExperienceOptions(add){
	if(time_option == "experienced"){
		adjustPlayback(add);
	} else if (time_option =="real"){
		audio.playbackRate = 1;
	}
	if(zoom_option=="dynamic"){
		alignScoreView(add.length)
	}else if(zoom_option=="locked"){
		score_view = document.querySelector('#page1');
		score_view.style.height=height/8+"px";
	}
}

function createComment(data, id, role){
	reactions = document.querySelector('#reactions');
	comment = data['MOM1CHAR'];
	div = document.createElement('div');
	div.setAttribute("class","item")
	div.setAttribute('id',id);
	h3 = document.createElement('h3');
	h3.innerHTML=role;
	p = document.createElement('p');
	p.innerHTML="'"+comment+"'";
	label = document.createElement('label');
	div.appendChild(h3);
	div.appendChild(p);
	reactions.prepend(div);
}


function getpos(event) {
	var e = window.event;
	x = e.clientX + "px";
	y = e.clientY + "px";
}

// setup signature view
function drawCircles(num_circles){

       var createNodes = function (numNodes, radius) {
         var nodes = [], 
             width = (radius * 2) + 50,
             height = (radius * 2) + 50,
             angle,
             x,
             y,
             i;
         for (i=0; i<numNodes; i++) {
          angle = (i / (numNodes/2)) * Math.PI; // Calculate the angle at which the element will be placed.
                                                // For a semicircle, we would use (i / numNodes) * Math.PI.
          x = (radius * Math.cos(angle)) + (width/2); // Calculate the x position of the element.
          y = (radius * Math.sin(angle)) + (width/2); // Calculate the y position of the element.
          nodes.push({'id': i+1, 'x': x, 'y': y});
         }
         return nodes;
       }

       var createSvg = function (radius, callback) {
         d3.selectAll('svg').remove();
         var svg = d3.select('#canvas')
         	.append('svg')
            .attr('width', (radius * 2) + 50)
            .attr('height', (radius * 2) + 50);
        	callback(svg);
       }

       var createElements = function (svg, nodes, elementRadius) {
         element = svg.selectAll('circle')
            .data(nodes)
            .enter()
            .append('circle')
            .attr("id", function(d,i){return "person" + d.id})
            .attr('r', elementRadius)
            .attr('cx', function (d, i) {return d.x;})
            .attr('cy', function (d, i) {return d.y;})
            .append('text')
            .attr("x", function(d){return d.x})
            .attr("y", function(d){return d.y})
       }

       var draw = function () {
       	view = document.querySelector('.view');
		view_height = view.style.height;
		view_height = view_height.split("px");
		view_height = view_height[0]
		view_width = view.clientWidth;
		console.log(view_height);
         var numNodes = num_circles;
         var radius;
         if(window.innerWidth<=767){
         	radius = view_width/4;
         } else {
         	radius = view_height/8;
         }
         
         var nodes = createNodes(numNodes, radius);
         createSvg(radius, function (svg) {
           createElements(svg, nodes, 10);
         });
       }

       document.addEventListener('DOMContentLoaded', (event) => {
          draw();
          showSigPpl();
        })
}
// draw shared network for signature view
function drawPath(point1_id, point2_id, sig_class) {

            var p1x = parseFloat(document.getElementById(point1_id).getAttribute("cx"));
            var p1y = parseFloat(document.getElementById(point1_id).getAttribute("cy"));
            var p2x = parseFloat(document.getElementById(point2_id).getAttribute("cx"));
            var p2y = parseFloat(document.getElementById(point2_id).getAttribute("cy"));

            // mid-point of line:
            var mpx = (p2x + p1x) * 0.5;
            var mpy = (p2y + p1y) * 0.5;

            // angle of perpendicular to line:
            var theta = Math.atan2(p2y - p1y, p2x - p1x) - Math.PI / 2;

            // distance of control point from mid-point of line:
            var offset = 30;

            // location of control point:
            var c1x = mpx + offset * Math.cos(theta);
            var c1y = mpy + offset * Math.sin(theta);

            // center of svg
           	this_h=document.querySelector('svg').clientHeight;
            c1x =this_h/2;
            c1y=this_h/2;

            // construct the command to draw a quadratic curve
            var curve = "M" + p1x + " " + p1y + " Q " + c1x + " " + c1y + " " + p2x + " " + p2y;

            path = d3.select('svg')
              .append('path')
              .attr("class","curve "+sig_class)
              .attr('d', curve);

            path
              .transition()        
              .duration(1000)
              .ease(d3.easeLinear)
        }

// highlight unique reactions in signature view
function highlight(point, sig_class){
	var highlight = document.getElementById(point);
	highlight.classList.add(sig_class);
	// highlight.setAttribute("r",15);
}

function showSigPpl() {
	tooltip=document.querySelector('.tooltip');
	circles = document.querySelectorAll('circle');
	for(i=0;i<circles.length;i++){
		circles[i].onmouseover=function() {
			// get mouse event
			getpos();
			text= this.id;
			if(text=="person15" || text=="person16" || text=="person17" || text=="person18"){
				
				if(text=="person15"){
					text= "Performing pianist";
				}
				if(text=="person16"){
					text= "Performing cellist";
				}
				if(text=="person17"){
					text= "Non-performing pianist";
				}
				if(text=="person18"){
					text="Non-performing cellist";
				}
			} else {
				test = Number.isInteger(parseInt(text.slice(-2)));
				if(test==true){
					ending = parseInt(text.slice(-2));
					text = "Class member "+ ending;
				} else if (test==false) {
					ending = parseInt(text.slice(-1));
					text = "Class member "+ ending;
				}
				
			}
			tooltip.style.display="inline-block";
			tooltip.innerHTML = caps(text.replace(/_/g, " "));
		  	tooltip.style.left=x;
		  	tooltip.style.top=y;
		}
		circles[i].onmouseout=function() {
			tooltip.style.display="none";
		}
	}
}


// setup spatial view
function spatial() {
	tooltip=document.querySelector('.tooltip');
	people = document.querySelectorAll('.person');
	for(i=0;i<people.length;i++){
		people[i].onmouseover=function() {
			// get mouse event
			getpos();
			text= this.id;
			tooltip.style.display="inline-block";
			tooltip.innerHTML = caps(text.replace(/_/g, " "));
		  	tooltip.style.left=x;
		  	tooltip.style.top=y;
		}
		people[i].onmouseout=function() {
			tooltip.style.display="none";
		}
	}
}

function updateSpatial(data, role){
	role = role.replace(/\s/g, "_");
	role = role.toLowerCase();
	rate1 = parseInt(data['rater1_reassigned']);
	rate2 = parseInt(data['rater1_reassigned']);
	rater1 = data['rater1'].replace(/\s/g, "_").toLowerCase();
	rater1 = document.getElementById(rater1);
	rater2 = data['rater2'].replace(/\s/g, "_").toLowerCase();
	rater2 = document.getElementById(rater2);
	sentiment = data['sentiment'];
	target = document.getElementById(role);
	if(sentiment == "pos"){
		target.classList.add('posFade');
		if(rate1<3){
			rater1.classList.add('negFade');
		} else {
			rater1.classList.add('posFade');
		}
		if(rate2<3){
			rater2.classList.add('negFade');
		} else {
			rater2.classList.add('posFade');
		}
	} else if (sentiment == "neg") {
			target.classList.add('negFade');
		if(rate1<3){
			rater1.classList.add('posFade');
		} else {
			rater1.classList.add('negFade');
		}
		if(rate2<3){
			rater2.classList.add('posFade');
		} else {
			rater2.classList.add('negFade');
		}
	} else if (sentiment == "mixed" | sentiment =="other"){
		target.classList.add('mixedFade');

	}
	setTimeout( ()=> {
		role = this.role.toString();
		role = role.replace(/\s/g, "_").toLowerCase();
		role = document.getElementById(role);
		if(role.classList.contains('posFade')){
			role.classList.remove('posFade')
		} else if (role.classList.contains('negFade')){
			role.classList.remove('negFade')
		} else if (role.classList.contains('mixedFade')){
			role.classList.remove('mixedFade')
		};
		if(rater1.classList.contains('posFade')){
			rater1.classList.remove('posFade')
		} else if (rater1.classList.contains('negFade')){
			rater1.classList.remove('negFade')
		} else if (rater1.classList.contains('mixedFade')){
			rater1.classList.remove('mixedFade')
		};
		if(rater2.classList.contains('posFade')){
			rater2.classList.remove('posFade')
		} else if (rater2.classList.contains('negFade')){
			rater2.classList.remove('negFade')
		} else if (rater2.classList.contains('mixedFade')){
			rater2.classList.remove('mixedFade')
		};
	},10000)

}

// dynamic or locked view of score based on # of reactions 
function alignScoreView(comments_count){
	console.log(comments_count)
	score_view = document.querySelector('#page1');
	perspective = document.querySelector('.perspective');
	perspective_h = perspective.offsetHeight;
	container_view = document.querySelector('.view');
	container_height= container_view.offsetHeight;
	height = window.innerHeight;
		if (comments_count<1){
			score_view.style.height=(container_height-15)+"px";
		} else if (comments_count>=1 && comments_count <3){
			score_view.style.height=height/4+"px";
		} else if (comments_count >= 3) {
			score_view.style.height=height/8+"px";
		};
}

// number of agreements/disagreements by raters for each reaction
function displayEndorsement(data, comment_id){
	results = [];
	rater1 = parseInt(data['rater1_reassigned']);
	if(rater1<3){
		results.push({
			rater: data['rater1'],
			judgement:"disagree"
		});
	} else {
		results.push({
			rater: data['rater1'],
			judgement:"agree"
		});
	}
	rater2 = data['rater2_reassigned'];
	if(rater2<3){
		results.push({
			rater: data['rater2'],
			judgement:"disagree"
		});
	} else {
		results.push({
			rater: data['rater2'],
			judgement:"agree"
		});
	}
	agrees = results.filter(function(d) {return d.judgement =="agree"})
	disagrees = results.filter(function(d) {return d.judgement =="disagree"})
	target = document.getElementById(comment_id);
	endorsements = document.createElement('div');
	endorsements.setAttribute("class", "endorsements");
	endorsements.innerHTML="<div class='social agree' name="+ comment_id +"><em>"+ agrees.length + " <i class='material-icons'>thumb_up</i></em></div><div class='social disagree' name="+ comment_id +"><em>"+ disagrees.length + " <i class='material-icons' style='transform:translate(360deg);color:#CCCCCC'>thumb_down</i></em></div>";
	target.prepend(endorsements);
}

function endorsementsDetail(data) {
	tooltip=document.querySelector('.tooltip');
	agrees = document.querySelectorAll(".agree");
	disagrees = document.querySelectorAll(".disagree");
	for (i=0;i<agrees.length;i++){
		agrees[i].onmouseover=function() {
			agree = [];
			disagree = [];
			getpos();
			tooltip.style.left=x;
			tooltip.style.top=y;
			comment_id = this.getAttribute("name");
			index = data.findIndex(obj => obj.comment_id==comment_id);
			if(parseInt(data[index]['rater1_reassigned'])<3){
				disagree.push(data[index]['rater1'])
			} else {
				agree.push(data[index]['rater1'])
			}
			if(parseInt(data[index]['rater2_reassigned'])<3){
				disagree.push(data[index]['rater2'])
			} else {
				agree.push(data[index]['rater2'])
			}
			displayEndorsement();

			function displayEndorsement() {
				if(agree.length!=0){
					tooltip.style.display="inline-block";
					tooltip.innerHTML="";
					for(j=0;j<agree.length;j++){
					tooltip.innerHTML+="<div>"+agree[j]+"</div>"
					}
				}
			}
		}
		agrees[i].onmouseout=function() {
			tooltip.style.display="none";
		}
	}
	for (i=0;i<disagrees.length;i++){
	disagrees[i].onmouseover=function() {
		agree = [];
		disagree = [];
		getpos();
		tooltip.style.left=x;
		tooltip.style.top=y;
		comment_id = this.getAttribute("name");
		index = data.findIndex(obj => obj.comment_id==comment_id);
		if(parseInt(data[index]['rater1_reassigned'])<3){
			disagree.push(data[index]['rater1'])
		} else {
			agree.push(data[index]['rater1'])
		}
		if(parseInt(data[index]['rater2_reassigned'])<3){
			disagree.push(data[index]['rater2'])
		} else {
			agree.push(data[index]['rater2'])
		}
		displayEndorsement();

		function displayEndorsement() {
			if(disagree.length!=0){
				tooltip.style.display="inline-block";
				tooltip.innerHTML="";
				for(j=0;j<disagree.length;j++){
				tooltip.innerHTML+="<div>"+disagree[j]+"</div>"
				}
			}
		}
	}
	disagrees[i].onmouseout=function() {
		tooltip.style.display="none";
	}
}

}

// each reaction's category by sentiment
function displayTags(data, comment_id){
	tags = []
	categories=['dynamics', 'dynamics and balance', 'balance', 'tempo', 'timing', 'rhythmic motion', 'sychronization', 'communication', 'matching_musical_idea', 'expressivity', 'character', 'tone quality', 'ending'];
	for(i=0;i<categories.length;i++){
		category = categories[i];
		if(data[category]!=undefined && data[category]!= ""){
			tags.push({
				tag: category,
				sentiment:data[category]
			});
		}
	}
	for(i=0;i<tags.length;i++){
		category_tag = document.createElement('div');
		category_tag.setAttribute("class", "tag");
		category_tag.setAttribute("value",tags[i]['sentiment'] )
		category_tag.innerHTML=tags[i]['tag'];
		target = document.getElementById(comment_id);
		target.appendChild(category_tag);
	}

}

// adjust audio playback rate based on # reactions
function adjustPlayback(data) {
	slow=0.4;
	normal=1;
	fast=2;
	veryfast=2.5
	if(data.length==0){
		audio.playbackRate = veryfast;
	} else if(data.length==1){
		audio.playbackRate = fast;
	}else if (data.length>1 && data.length <3){
		audio.playbackRate = normal;
	} else {
		audio.playbackRate = slow;
	}
}

// highlight score image and scroll to it during audio play
function reset() {
	overlays = document.querySelectorAll('.overlay');
	for(i=0;i<overlays.length;i++){
		overlays[i].style.opacity="0.5";
		overlay.style.removeProperty('background');
	}
}

function hover(img){
	target = document.querySelector('#page-holder'+img)
	overlay = target.querySelector('.overlay');
	// overlay.style.opacity="0.2";
	overlay.style.background="linear-gradient(to left, rgba(0,0,0,1), rgba(0,0,0,0)), linear-gradient(to right, rgba(0,0,0,1), rgba(0,0,0,0))";
}

function scrollTo(img){
	scrollpost = document.querySelector('.page');
	test=document.querySelector('#page-holder'+img);
	target=test.offsetLeft - window.innerWidth/2;
	if(time_option=="dynamic"){
		scrollpost.scrollTo({
		  left: target,
		  behavior: 'smooth'
		});
	}else {
		scrollpost.scrollTo({
		  left: target,
		  // behavior:'smooth'
		});
	}

}

//calculate which measure each beat falls under
function getScore() {
	for(i=1;i<274;i++){
		target=document.querySelector('#page1');
		height=window.innerHeight
		div = document.createElement('div');
		div.setAttribute("class","page-holder");
		div.setAttribute("id","page-holder"+i);
		overlay=document.createElement('div');
		overlay.setAttribute("class","overlay");
		img = document.createElement('img');
		img.src="assets/cropped/500w/"+i+".png";
		target.style.height=height/8+"px";
		div.style.height="100%";
		div.appendChild(img);
		div.appendChild(overlay);
		target.appendChild(div);
	}
}

// resize reactions container based on window size
function resizeInterface() {
	fill = document.querySelector('.fill');
	header=document.querySelector('header');
	header_h=header.offsetHeight;
	check=document.querySelector('.page');
	check.style.marginTop=header_h+"px";
	calc_h = check.offsetHeight;
	page_height = check.style.height;
	view = document.querySelector('.view');
	offset = header_h+calc_h;
	view_height = window.innerHeight - offset+"px";
	view.style.height=view_height;
	start_message = document.querySelector('#start-message');
	if(start_message!=null){
		start_message.style.height=view.offsetHeight+"px";
	}
	fill.style.height = (calc_h*4) + "px";
	toggleScore();

}

function toggleScore() {
	page = document.querySelector('.page');
	view2 = document.querySelector('#reactions2');
	view3 = document.querySelector('#reactions3');
	return_h =page.style.height;
	var toggle = function (a, b) {
	    var togg = false;
	    return function () {
	        return (togg = !togg) ? a() : b();
	    };
	};
	
	view2.addEventListener('click', toggle(function () {
	    page.style.height="0px";
	}, function () { 
		page.style.height=return_h;
	}));
	view3.addEventListener('click', toggle(function () {
	    page.style.height="0px";
	}, function () { 
		page.style.height=return_h;
	}));	
}


</script>
</html>