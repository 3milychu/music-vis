<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link href="https://fonts.googleapis.com/css?family=Overpass:200,300,400,600,800" rel="stylesheet">
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
<!-- audio -->
<header>
		<div class="filters">
		<div class="option" name="playback" value="experienced">Experienced time</div>
		<div class="option" name="playback" value="real">Real time</div>
	</div>
	<audio controls>
	  <source src="assets/music.wav" type="audio/wav">
	</audio>
</header>

<!-- score page-->
<div class="page" id="page1">
</div>

<!-- reactions -->
<div class="view">
	<input value="10"></input>

	<div id="reactions">
		<div id="start-message">
			<div class="button" id="play">Play</div>
		</div>
	</div>

</div>

<!-- vis perspective -->
<div class="perspective">
		<div class="option" id="space"><i class="material-icons">flare</i></div>
		<div class="option" id="activity"><i class="material-icons">chat_bubble_outline</i></div>
		<div class="option" id="signature"><i class="material-icons">fingerprint</i></div>
</div>

</body>
<script>

var audio;
var measure;
var beat;
var ref = document.querySelector('input');
var watch = "same";
formatTime = d3.format(",.1f");
var time_option;

//mobile view
if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
    page=document.querySelectorAll('.page');
    for(i=0;i<page.length;i++){
    	page[i].style.height="120vh";
    }
};

function calculateSize() {
	h=window.innerHeight*4;
	if(h!=2580){
		transform = h/2580;
		pages =document.querySelectorAll('.page')
		for(i=0;i<pages.length;i++){
			pages[i].style.transform="scale("+transform+")";
		}
	}
}

window.onresize=function() {
	calculateSize();
}

// run functions
getScore();
d3.csv('data/timestamps.csv')
	.then(function(data) {
		getMusic(data);
	})
	.catch(function(error){
	})

function loadReactions() {
	d3.json('https://raw.githubusercontent.com/3milychu/music-vis/master/data/moment_all.json')
	.then(function(data){
		getReactions(data);
	})
	.catch(function(error){

	})
}
resizeInterface();
window.onresize=function() {
	resizeInterface();
}
status();
optionsListen("playback");
document.querySelector('.option[value="experienced"]').click();
time_option="experienced";

// play on audio click
audio = document.querySelector('audio');
audio.onclick=function() {
	clear();
}
// play on play button click
play = document.querySelector('.button');
play.onclick=function() {
	clear();
	audio.play();
}

// clear reactions container
function clear() {
	console.log("clear")
	target=document.querySelector('#reactions');
	target.innerHTML="";
}

// load music
function getMusic(data) {
	music = document.querySelector('audio')
	setInterval(function () {
	    time = formatTime(music.currentTime);
		filter = data.filter(function(d){
	    	return (formatTime(d.timestamp).indexOf(time) === 0);
		 })
		if(filter.length==1){
			reset();
			label = filter[0]['img'];
			hover(label);
			scrollTo(label);
			measure = filter[0]['measure'];
			beat = filter[0]['beat'];
			if(ref.value!=measure+beat) {
				ref.value= measure+beat;
				watch = "changed";
			} else {
				watch ="same"
			}
			loadReactions();
		} 
	}, 20);
}

function optionsListen(name) {
	options=document.querySelectorAll(".option[name='"+ name +"']");
	for(i=0;i<options.length;i++){
		options[i].onclick=function(){
			for(i=0;i<options.length;i++){
				options[i].style.backgroundColor="transparent";
				options[i].style.color="black";
			}
			this.style.backgroundColor="black";
			this.style.color="white";
			console.log(this.innerHTML);
			if(this.innerHTML=="Experienced time"){
				time_option = "experienced";
			}else if(this.innerHTML=="Real time") {
				time_option = "real";
			}
		}
	}
}

// get selections
status = [];
function status() {
	options= document.querySelectorAll('.option');
	for(i=0;i<options.length;i++){
		color=options[i].style.backgroundColor;
	}
	
}

// get reactions
function getReactions(data){
	reactions = document.querySelector('#reactions');
	if(watch =="changed") {
		console.log("changed")
		clear();
		console.log(ref.value);
		add= data.filter(function(d){
    	return ((parseInt(d.MOM_STARTBAR+d.MOM_STARTBEAT) <= ref.value) && (parseInt(d.MOM_ENDBAR+d.MOM_ENDBEAT) >= ref.value));
		 })
		console.log(time_option);
		if(time_option == "experienced"){
			adjustPlayback(add);
		} else if (time_option =="real"){
			audio.playbackRate = 1;
		}
		console.log(add);
		if(add.length!=0){
			for (i=0;i<add.length;i++){
				id = add[i]['comment_id'];
				test = document.getElementById(id);
				console.log(test);
				if(test==null){
					comment = add[i]['MOM1CHAR'];
					div = document.createElement('div');
					div.setAttribute("class","item")
					div.setAttribute('id',id);
					h3 = document.createElement('h3');
					h3.innerHTML=add[i]['role'];
					p = document.createElement('p');
					p.innerHTML="'"+comment+"'";
					label = document.createElement('label');
					div.appendChild(h3);
					div.appendChild(p);
					reactions.prepend(div);
					displayEndorsement(add[i], id);
				}
			}
		}
	};
}

function displayEndorsement(data, comment_id){
	results = [];
	rater1 = data['rater1_reassigned'];
	if(rater1<3){
		results.push("disagree")
	} else {
		results.push("agree")
	}
	rater2 = data['rater2_reassigned'];
	if(rater2<3){
		results.push("disagree")
	} else {
		results.push("agree")
	}
	agrees = results.filter(item => item == "agree" )
	disagrees = results.filter(item => item == "disagree")
	console.log(agrees);
	console.log(comment_id)
	target = document.getElementById(comment_id);
	console.log(target)
	endorsements = document.createElement('div');
	endorsements.setAttribute("class", "endorsements");
	endorsements.innerHTML="<div class=social><em>"+ agrees.length + " <i class='material-icons'>thumb_up</i></em></div><div class=social><em>"+ disagrees.length + " <i class='material-icons' style='transform:translate(360deg);color:#CCCCCC'>thumb_down</i></em></div>";
	target.prepend(endorsements);
}

function displayTags(data){

}

// adjust audio playback rate based on # reactions
function adjustPlayback(data) {
	slow=0.5;
	normal=1;
	fast=2;
	veryfast=2.5
	console.log(data.length);
	if(data.length==0){
		audio.playbackRate = veryfast;
	} else if(data.length==1){
		audio.playbackRate = fast;
	}else if (data.length>1 && data.length <3){
		audio.playbackRate = normal;
	} else {
		audio.playbackRate = slow;
	}
	console.log(audio.playbackRate);
}

// highlight score image and scroll to it during audio play
function reset() {
	overlays = document.querySelectorAll('.overlay');
	for(i=0;i<overlays.length;i++){
		overlays[i].style.opacity="0"
	}
}

function hover(img){
	target = document.querySelector('#page-holder'+img)
	overlay = target.querySelector('.overlay');
	overlay.style.opacity="0.7"
}

function scrollTo(img){
	scrollpost = document.querySelector('.page');
	test=document.querySelector('#page-holder'+img);
	target=test.offsetLeft - window.innerWidth/2;
	scrollpost.scrollTo({
	  left: target,
	  behavior: 'smooth'
	});
}

//calculate which measure each beat falls under
function getScore() {
	measures=[1];
	measure_start=1
	for(i=1;i<=16;i++){
		measure_start=measure_start+4;
		measures.push(measure_start);
	}
	console.log(measures);
	for(i=1;i<144;i++){
		target=document.querySelector('#page1');
		width=window.innerWidth*.70;
		height=window.innerHeight*4;
		div = document.createElement('div');
		div.setAttribute("class","page-holder");
		div.setAttribute("id","page-holder"+i);
		overlay=document.createElement('div');
		overlay.setAttribute("class","overlay");
		img = document.createElement('img');
		img.src="assets/cropped/500w/"+i+".png";
		div.style.height=height/30+"px";
		div.appendChild(img);
		div.appendChild(overlay);
		target.appendChild(div);
	}
}

// resize reactions container based on window size
function resizeInterface() {
	header=document.querySelector('header');
	header_h=header.offsetHeight;
	check=document.querySelector('.page');
	check.style.marginTop=header_h+"px";
	calc_h = check.offsetHeight;
	view = document.querySelector('.view');
	offset = header_h+calc_h;
	view.style.height=window.innerHeight - offset+"px";
	start_message = document.querySelector('#start-message');
	start_message.style.height=view.offsetHeight+"px";
}


</script>
</html>