<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<style>
body, html {
	top:0;
	left:0;
	margin:0;
	padding:0;
}
.page {
	display:block;
	width:70%;
	height:400vh;
	overflow-x:hidden;
}
.page-holder {
	position:relative;
	display:inline-block;
	vertical-align:top;
	width:auto;
	cursor:pointer;
}
.page-holder img {
	height:100%;
	width:auto;
}
.overlay {
	position:absolute;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	height: 100%;
	width: 100%;
	opacity: 0;
	transition: .5s ease;
/*	background-color: #008CBA;*/
	background-color: black;
	z-index:2;
	background-blend-mode: multiply;
}
/*.page-holder:hover .overlay {
	opacity:0.5;
}*/
header {
	position:fixed;
	bottom:0;
	width:100%;
	box-shadow: 0.05em 0.05em 1em #666666;
	z-index:100;
	background-color:#F2F2F2;
	padding:1%;
	height:fit-content;
	text-align:center;
}
audio {
	width:80%;
	padding:0%;
	margin:0%;
}
.sidebar {
	position:fixed;
	right:0;
	width:30%;
	background-color:#F2F2F2;
	height:100vh;
}
</style>
<body>
<!-- audio -->
<header>
	<audio controls>
	  <source src="assets/music.wav" type="audio/wav">
	</audio>
</header>

<!-- reactions -->
<div class="sidebar">
	<div id="reactions"></div>
</div>

<!-- score page-->
<div class="page" id="page1">
</div>

</body>
<script>

formatTime = d3.format(",.1f");
var measure;
var beat;
var ref;

//mobile view
if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
    page=document.querySelectorAll('.page');
    for(i=0;i<page.length;i++){
    	page[i].style.height="120vh";
    }
};

// run functions
getScore();
d3.csv('data/timestamps.csv')
	.then(function(data) {
		getMusic(data);
	})
	.catch(function(error){
	})

function loadReactions() {
	d3.json('https://raw.githubusercontent.com/3milychu/music-vis/master/data/moment_all.json')
	.then(function(data){
		getReactions(data);
	})
	.catch(function(error){

	})
}

// load music
function getMusic(data) {
	hover(1);
	music = document.querySelector('audio')
	setInterval(function () {
	    time = formatTime(music.currentTime);
		filter = data.filter(function(d){
	    	return (formatTime(d.timestamp).indexOf(time) === 0);
		 })
		if(filter.length==1){
			reset();
			label = filter[0]['img'];
			hover(label);
			scrollTo(label);
			measure = filter[0]['measure'];
			beat = filter[0]['beat'];
			ref = measure+"-"+beat;
			loadReactions();
		} 
	}, 30);
}

// get reactions
function getReactions(data){
	reactions = document.querySelector('#reactions');
	console.log(measure,beat)
	filter2 = data.filter(function(d){
    	return ((d.MOM.STARTBAR == "'"+measure+"'") && (d.MOM.STARTBEAT == "'"+beat+"'"));
	 })
	console.log(filter2);
	if(filter2.length!=0){
		for (i=0;i<filter2.length;i++){
			comment = filter[i]['MOM1CHAR'];
			id = filter[i]['comment_id'];
			div = document.createElement('div');
			div.setAttribute('id',id);
			p = document.createElement('p');
			p.innerHTML=comment;
			div.appendChild(p);
			reactions.appendChild(div);
		}
	}
}
// helper functions to highlight played moment in score and scroll to it in window
function reset() {
	overlays = document.querySelectorAll('.overlay');
	for(i=0;i<overlays.length;i++){
		overlays[i].style.opacity="0"
	}
}

function hover(img){
	target = document.querySelector('#page-holder'+img)
	overlay = target.querySelector('.overlay');
	overlay.style.opacity="0.5"
}

function scrollTo(img){
	target = document.querySelector('#page-holder'+img);
	target.scrollIntoViewIfNeeded();
}

//calculate which measure each beat falls under
function getScore() {
	measures=[1];
	measure_start=1
	for(i=1;i<=16;i++){
		measure_start=measure_start+4;
		measures.push(measure_start);
	}
	console.log(measures);
	for(i=1;i<61;i++){
		target=document.querySelector('#page1');
		width=window.innerWidth*.70;
		height=window.innerHeight*4;
		div = document.createElement('div');
		div.setAttribute("class","page-holder");
		div.setAttribute("id","page-holder"+i);
		overlay=document.createElement('div');
		overlay.setAttribute("class","overlay");
		img = document.createElement('img');
		img.src="assets/page1/"+i+".png";
		if(i<13){
			div.style.height=height/6+"px";
		}else if (i>44){
			div.style.height=height/9.5+"px";
		} else {
			div.style.height=height/13+"px";
		}
		div.appendChild(img);
		div.appendChild(overlay);
		target.appendChild(div);
	}
}

</script>
</html>