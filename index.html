<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link href="https://fonts.googleapis.com/css?family=Overpass:200,300,400,600,800" rel="stylesheet">
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="styles.css">
	<script src="https://cdn.jsdelivr.net/npm/vue"></script>
	<meta name="viewport" content="width=device-width">
</head>
<body>
<!-- audio -->
<header>
	<div class="filters">
		<div class="option zoom" name="zoom" value="dynamic">Dynamic View</div>
		<div class="option zoom" name="zoom" value="locked">Locked View</div>
	</div>
	<div class="filters">
		<div class="option playback" name="playback" value="experienced">Experienced time</div>
		<div class="option playback" name="playback" value="real">Real time</div>
	</div>

	<audio controls>
	  <source src="assets/music.wav" type="audio/wav">
	</audio>
</header>

<!-- score page-->
<div class="page" id="page1">
</div>

<!-- reactions -->
<div class="view">
	<input value="10"></input>

	<!-- comments -->
	<div id="reactions">
		<div id="start-message">
			<div class="button" id="play">Play</div>
		</div>
	</div>
	<!-- spatial -->
	<div id="reactions2">
		<div id="hall">
			<div class="performers">
				<div class="person performer" id="performing_pianist"></div>
				<div class="person performer" id="performing_cellist"></div>
			</div>
			<div class="audience">
				<div class="person member" id="class_member_1"></div>
				<div class="person member" id="class_member_2"></div>
				<div class="person member" id="class_member_3"></div>
				<div class="person member" id="class_member_4"></div>
				<div class="person member" id="class_member_5"></div>
				<div class="person member" id="class_member_6"></div>
				<div class="person member" id="class_member_7"></div>
				<div class="person member" id="class_member_8"></div>
				<div class="person member" id="class_member_9"></div>
				<div class="person member" id="class_member_10"></div>
				<div class="person member" id="class_member_11"></div>
				<div class="person member" id="class_member_12"></div>
				<div class="person member" id="class_member_13"></div>
				<div class="person member" id="class_member_14"></div>
			</div>
			<div class="backups">
				<div class="person backup" id="non-performing_pianist"></div>
				<div class="person backup" id="non-performing_cellist"></div>
			</div>
		</div>
	</div>
	<!-- signature -->
	<div id="reactions3">
		<h2>Signature view coming soon!</h2>
	</div>


</div>

<!-- vis perspective -->
<div class="perspective">
		<div class="option" id="spatial">
			<div class="label">Spatial View</div>
			<div class="circle-button">
				<i class="material-icons">flare</i>
			</div>
		</div>
		<div class="option" id="comments">
			<div class="label">Comments View</div>
			<div class="circle-button">
				<i class="material-icons">chat_bubble_outline</i>
			</div>
		</div>
		<div class="option" id="signature">
			<div class="label">Signature View</div>
			<div class="circle-button">
				<i class="material-icons">fingerprint</i>
			</div>
		</div>
</div>

<!-- view tooltip -->
<div class="tooltip"></div>

</body>
<!-- <script type="text/javascript" src="computed.js"></script> -->
<script>
var formatTime = d3.format(",.2f");
var music = document.querySelector('audio');
var time;
var view;
var audio;
var measure;
var beat;
var ref = document.querySelector('input');
var watch = "same";
var time_option;
var zoom_option;

// var sound = new Howl({
//   src: ['sound.mp3']
// });

// sound.play();

//mobile view
if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
    page=document.querySelectorAll('.page');
    for(i=0;i<page.length;i++){
    	page[i].style.height="120vh";
    }
};

// run functions
window.onload=function() {
	spatial();
}
getScore();
d3.csv('data/timestamps.csv')
	.then(function(data) {
		getMusic(data);
	})
	.catch(function(error){
	})

function loadReactions() {
	d3.json('https://raw.githubusercontent.com/3milychu/music-vis/master/data/moment_all.json')
	.then(function(data){
		getReactions(data);
		endorsementsDetail(data);
	})
	.catch(function(error){

	})
}
resizeInterface();
window.onresize=function() {
	resizeInterface();
}
optionsListen("playback");
document.querySelector('.option[value="real"]').click();
optionsListen("zoom");
document.querySelector('.option[value="locked"]').click();
status();
document.querySelector('#comments').click();

// play on audio click
audio = document.querySelector('audio');
audio.onclick=function() {
	clear();
}
// play on play button click
play = document.querySelector('.button');
play.onclick=function() {
	clear();
	audio.play();
	
}

// clear reactions container
function clear() {
	console.log("clear")
	target=document.querySelector('#reactions');
	target.innerHTML="";
}

// load music
function getMusic(data) {
	setInterval(function () {
		time = formatTime(music.currentTime);
		filter = data.filter(function(d){
	    	return (formatTime(d.timestamp).indexOf(time) == 0);
		 })
		if(filter.length==1){
			roll(filter[0]);
		} 
	}, 0);
}

function roll(data) {
	reset();
	label = data['img'];
	hover(label);
	scrollTo(label);
	measure = data['measure'];
	beat = data['beat'];
	if(ref.value!=measure+beat) {
	ref.value= measure+beat;
	watch = "changed";
	} else {
	watch ="same"
	}
	loadReactions();
}

function optionsListen(name) {
	options=document.querySelectorAll("div[name="+name+"]");
	for(i=0;i<options.length;i++){
		options[i].onclick=function(){
			this.style.backgroundColor="black";
			this.style.color="white";
			if(this.innerHTML=="Experienced time"){
				time_option = "experienced";
				modify = document.querySelector('div[value=real]');
			}else if(this.innerHTML=="Real time") {
				time_option = "real";
				modify = document.querySelector('div[value=experienced]');
			} else if(this.innerHTML=="Dynamic View"){
				zoom_option= "dynamic";
				modify = document.querySelector('div[value=locked]');
			} else if (this.innerHTML=="Locked View"){
				zoom_option="locked";
				modify = document.querySelector('div[value=dynamic');
			}
			modify.style.backgroundColor="transparent";
			modify.style.color="black";
			console.log(this.innerHTML);
			console.log(time_option);
			console.log(zoom_option);
		}
	}
}

// capitalize first letter
function caps(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

// get selections
status = [];
function status() {
	perspective = document.querySelector('.perspective');
	p_options = perspective.querySelectorAll('.option');
	for (i=0;i<p_options.length;i++){
		p_options[i].onclick=function() {
			for(j=0;j<p_options.length;j++){
				modify = p_options[j].querySelector('.circle-button');
				modify.style.backgroundColor="#F2F2F2";
				modify.style.color="black";
				modify.style.transform="scale(0.7)";
			}
			// change color
			target = document.getElementById(this.id);
			target = target.querySelector('.circle-button');
			target.style.transform="scale(1)";
			target.style.backgroundColor="black";
			target.style.color="white";
			// change var view
			view = this.id;
			getView(view);
		}
	}
}

function getView(view){
	if(view == "comments"){
		document.querySelector('#reactions').style.display="inline-block";
		document.querySelector('#reactions2').style.display="none";
		document.querySelector('#reactions3').style.display="none";
	} else if (view == "spatial") {
		document.querySelector('#reactions').style.display="none";
		document.querySelector('#reactions2').style.display="inline-block";
		document.querySelector('#reactions3').style.display="none";
	} else if (view == "signature") {
		document.querySelector('#reactions').style.display="none";
		document.querySelector('#reactions2').style.display="none";
		document.querySelector('#reactions3').style.display="inline-block";
	}

}

// get reactions
function getReactions(data){
	// display reactions
	if(watch =="changed") {
		clear();
		add= data.filter(function(d){
    	return ((parseInt(d.MOM_STARTBAR+d.MOM_STARTBEAT) <= ref.value) && (parseInt(d.MOM_ENDBAR+d.MOM_ENDBEAT) >= ref.value));
		 })
		// add stuff
		if(add.length!=0){
			for (i=0;i<add.length;i++){
				info = add[i];
				id = info['comment_id'];
				comment = info['MOM1CHAR'];
				role = info['role'];
				test = document.getElementById(id);
				if(test==null|test==undefined){
					createComment(info,id,role)
					displayEndorsement(info, id);
					displayTags(info, id);
					updateSpatial(info, role);
				}
			}
		}
		// adjust playback rate
		if(time_option == "experienced"){
			adjustPlayback(add);
		} else if (time_option =="real"){
			audio.playbackRate = 1;
		}
		if(zoom_option=="dynamic"){
			alignScoreView(add.length)
		}else if(zoom_option=="locked"){
			score_view = document.querySelector('#page1');
			score_view.style.height=height/8+"px";
		}
	};
}

function createComment(data, id, role){
	reactions = document.querySelector('#reactions');
	comment = data['MOM1CHAR'];
	div = document.createElement('div');
	div.setAttribute("class","item")
	div.setAttribute('id',id);
	h3 = document.createElement('h3');
	h3.innerHTML=role;
	p = document.createElement('p');
	p.innerHTML="'"+comment+"'";
	label = document.createElement('label');
	div.appendChild(h3);
	div.appendChild(p);
	reactions.prepend(div);
}


function getpos(event) {
	var e = window.event;
	x = e.clientX + "px";
	y = e.clientY + "px";
}
// setup spatial view
function spatial() {
	tooltip=document.querySelector('.tooltip');
	people = document.querySelectorAll('.person');
	for(i=0;i<people.length;i++){
		people[i].onmouseover=function() {
			// get mouse event
			getpos();
			text= this.id;
			tooltip.style.display="inline-block";
			tooltip.innerHTML = caps(text.replace(/_/g, " "));
		  	tooltip.style.left=x;
		  	tooltip.style.top=y;
		}
		people[i].onmouseout=function() {
			tooltip.style.display="none";
		}
	}
}

function updateSpatial(data, role){
	role = role.replace(/\s/g, "_");
	role = role.toLowerCase();
	rate1 = parseInt(data['rater1_reassigned']);
	rate2 = parseInt(data['rater1_reassigned']);
	rater1 = data['rater1'].replace(/\s/g, "_").toLowerCase();
	rater1 = document.getElementById(rater1);
	rater2 = data['rater2'].replace(/\s/g, "_").toLowerCase();
	rater2 = document.getElementById(rater2);
	sentiment = data['sentiment'];
	target = document.getElementById(role);
	if(sentiment == "pos"){
		target.classList.add('posFade');
		if(rate1<3){
			rater1.classList.add('negFade');
		} else {
			rater1.classList.add('posFade');
		}
		if(rate2<3){
			rater2.classList.add('negFade');
		} else {
			rater2.classList.add('posFade');
		}
	} else if (sentiment == "neg") {
			target.classList.add('negFade');
		if(rate1<3){
			rater1.classList.add('posFade');
		} else {
			rater1.classList.add('negFade');
		}
		if(rate2<3){
			rater2.classList.add('posFade');
		} else {
			rater2.classList.add('negFade');
		}
	} else if (sentiment == "mixed" | sentiment =="other"){
		target.classList.add('mixedFade');

	}
	setTimeout( ()=> {
		role = this.role.toString();
		role = role.replace(/\s/g, "_").toLowerCase();
		role = document.getElementById(role);
		if(role.classList.contains('posFade')){
			role.classList.remove('posFade')
		} else if (role.classList.contains('negFade')){
			role.classList.remove('negFade')
		} else if (role.classList.contains('mixedFade')){
			role.classList.remove('mixedFade')
		};
		if(rater1.classList.contains('posFade')){
			rater1.classList.remove('posFade')
		} else if (rater1.classList.contains('negFade')){
			rater1.classList.remove('negFade')
		} else if (rater1.classList.contains('mixedFade')){
			rater1.classList.remove('mixedFade')
		};
		if(rater2.classList.contains('posFade')){
			rater2.classList.remove('posFade')
		} else if (rater2.classList.contains('negFade')){
			rater2.classList.remove('negFade')
		} else if (rater2.classList.contains('mixedFade')){
			rater2.classList.remove('mixedFade')
		};
	},10000)

}

// dynamic or locked view of score based on # of reactions 
function alignScoreView(comments_count){
	console.log(comments_count)
	score_view = document.querySelector('#page1');
	height = window.innerHeight;
		if (comments_count==0){
		score_view.style.height=height/2+"px";
		console.log(score_view.style.height)
		} else if (comments_count==1){
			score_view.style.height=height/4+"px";
		} else {
			score_view.style.height=height/8+"px";
		}
}

// number of agreements/disagreements by raters for each reaction
function displayEndorsement(data, comment_id){
	results = [];
	rater1 = parseInt(data['rater1_reassigned']);
	if(rater1<3){
		results.push({
			rater: data['rater1'],
			judgement:"disagree"
		});
	} else {
		results.push({
			rater: data['rater1'],
			judgement:"agree"
		});
	}
	rater2 = data['rater2_reassigned'];
	if(rater2<3){
		results.push({
			rater: data['rater2'],
			judgement:"disagree"
		});
	} else {
		results.push({
			rater: data['rater2'],
			judgement:"agree"
		});
	}
	agrees = results.filter(function(d) {return d.judgement =="agree"})
	disagrees = results.filter(function(d) {return d.judgement =="disagree"})
	target = document.getElementById(comment_id);
	endorsements = document.createElement('div');
	endorsements.setAttribute("class", "endorsements");
	endorsements.innerHTML="<div class='social agree' name="+ comment_id +"><em>"+ agrees.length + " <i class='material-icons'>thumb_up</i></em></div><div class='social disagree' name="+ comment_id +"><em>"+ disagrees.length + " <i class='material-icons' style='transform:translate(360deg);color:#CCCCCC'>thumb_down</i></em></div>";
	target.prepend(endorsements);
}

function endorsementsDetail(data) {
	tooltip=document.querySelector('.tooltip');
	agrees = document.querySelectorAll(".agree");
	disagrees = document.querySelectorAll(".disagree");
	for (i=0;i<agrees.length;i++){
		agrees[i].onmouseover=function() {
			agree = [];
			disagree = [];
			getpos();
			tooltip.style.left=x;
			tooltip.style.top=y;
			comment_id = this.getAttribute("name");
			index = data.findIndex(obj => obj.comment_id==comment_id);
			if(parseInt(data[index]['rater1_reassigned'])<3){
				disagree.push(data[index]['rater1'])
			} else {
				agree.push(data[index]['rater1'])
			}
			if(parseInt(data[index]['rater2_reassigned'])<3){
				disagree.push(data[index]['rater2'])
			} else {
				agree.push(data[index]['rater2'])
			}
			displayEndorsement();

			function displayEndorsement() {
				if(agree.length!=0){
					tooltip.style.display="inline-block";
					tooltip.innerHTML="";
					for(j=0;j<agree.length;j++){
					tooltip.innerHTML+="<div>"+agree[j]+"</div>"
					}
				}
			}
		}
		agrees[i].onmouseout=function() {
			tooltip.style.display="none";
		}
	}
	for (i=0;i<disagrees.length;i++){
	disagrees[i].onmouseover=function() {
		agree = [];
		disagree = [];
		getpos();
		tooltip.style.left=x;
		tooltip.style.top=y;
		comment_id = this.getAttribute("name");
		index = data.findIndex(obj => obj.comment_id==comment_id);
		if(parseInt(data[index]['rater1_reassigned'])<3){
			disagree.push(data[index]['rater1'])
		} else {
			agree.push(data[index]['rater1'])
		}
		if(parseInt(data[index]['rater2_reassigned'])<3){
			disagree.push(data[index]['rater2'])
		} else {
			agree.push(data[index]['rater2'])
		}
		displayEndorsement();

		function displayEndorsement() {
			if(disagree.length!=0){
				tooltip.style.display="inline-block";
				tooltip.innerHTML="";
				for(j=0;j<disagree.length;j++){
				tooltip.innerHTML+="<div>"+disagree[j]+"</div>"
				}
			}
		}
	}
	disagrees[i].onmouseout=function() {
		tooltip.style.display="none";
	}
}

}

// each reaction's category by sentiment
function displayTags(data, comment_id){
	tags = []
	categories=['dynamics', 'dynamics and balance', 'balance', 'tempo', 'timing', 'rhythmic motion', 'sychronization', 'communication', 'matching_musical_idea', 'expressivity', 'character', 'tone quality', 'ending'];
	for(i=0;i<categories.length;i++){
		category = categories[i];
		if(data[category]!=undefined && data[category]!= ""){
			tags.push({
				tag: category,
				sentiment:data[category]
			});
		}
	}
	for(i=0;i<tags.length;i++){
		category_tag = document.createElement('div');
		category_tag.setAttribute("class", "tag");
		category_tag.setAttribute("value",tags[i]['sentiment'] )
		category_tag.innerHTML=tags[i]['tag'];
		target = document.getElementById(comment_id);
		target.appendChild(category_tag);
	}

}

// adjust audio playback rate based on # reactions
function adjustPlayback(data) {
	slow=0.4;
	normal=1;
	fast=2;
	veryfast=2.5
	if(data.length==0){
		audio.playbackRate = veryfast;
	} else if(data.length==1){
		audio.playbackRate = fast;
	}else if (data.length>1 && data.length <3){
		audio.playbackRate = normal;
	} else {
		audio.playbackRate = slow;
	}
}

// highlight score image and scroll to it during audio play
function reset() {
	overlays = document.querySelectorAll('.overlay');
	for(i=0;i<overlays.length;i++){
		overlays[i].style.opacity="0"
	}
}

function hover(img){
	target = document.querySelector('#page-holder'+img)
	overlay = target.querySelector('.overlay');
	overlay.style.opacity="0.7"
}

function scrollTo(img){
	scrollpost = document.querySelector('.page');
	test=document.querySelector('#page-holder'+img);
	target=test.offsetLeft - window.innerWidth/2;
	if(time_option=="dynamic"){
		scrollpost.scrollTo({
		  left: target,
		  behavior: 'smooth'
		});
	}else {
		scrollpost.scrollTo({
		  left: target
		});
	}

}

//calculate which measure each beat falls under
function getScore() {
	for(i=1;i<193;i++){
		target=document.querySelector('#page1');
		height=window.innerHeight
		div = document.createElement('div');
		div.setAttribute("class","page-holder");
		div.setAttribute("id","page-holder"+i);
		overlay=document.createElement('div');
		overlay.setAttribute("class","overlay");
		img = document.createElement('img');
		img.src="assets/cropped/500w/"+i+".png";
		target.style.height=height/8+"px";
		div.style.height="100%";
		div.appendChild(img);
		div.appendChild(overlay);
		target.appendChild(div);
	}
}

// resize reactions container based on window size
function resizeInterface() {
	header=document.querySelector('header');
	header_h=header.offsetHeight;
	check=document.querySelector('.page');
	check.style.marginTop=header_h+"px";
	calc_h = check.offsetHeight;
	view = document.querySelector('.view');
	offset = header_h+calc_h;
	view.style.height=window.innerHeight - offset+"px";
	start_message = document.querySelector('#start-message');
	if(start_message!=null){
		start_message.style.height=view.offsetHeight+"px";
	}
}


</script>
</html>