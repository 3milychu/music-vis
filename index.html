<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link href="https://fonts.googleapis.com/css?family=Overpass:200,300,400,600,800" rel="stylesheet">
	<script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<style>
body, html {
	font-family:'Overpass', sans-serif;
	top:0;
	left:0;
	margin:0;
	padding:0;
}
.page {
	display:block;
	width:70%;
	height:400vh;
	overflow-x:hidden;
}
.page-holder {
	position:relative;
	display:inline-block;
	vertical-align:top;
	width:auto;
	cursor:pointer;
}
.page-holder img {
	height:100%;
	width:auto;
}
.overlay {
	position:absolute;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	height: 100%;
	width: 100%;
	opacity: 0;
	transition: .5s ease;
/*	background-color: #008CBA;*/
	background-color: black;
	z-index:2;
	background-blend-mode: multiply;
}
/*.page-holder:hover .overlay {
	opacity:0.5;
}*/
header {
	position:fixed;
	bottom:0;
	width:100%;
	box-shadow: 0.05em 0.05em 1em #666666;
	z-index:100;
	background-color:#F2F2F2;
	padding:1%;
	height:fit-content;
	text-align:center;
}
audio {
	width:80%;
	padding:0%;
	margin:0%;
}
.sidebar {
	position:fixed;
	right:0;
	width:30%;
	background-color:#F2F2F2;
	height:100vh;
	overflow-y:scroll;
}
#reactions .item {
	padding:5%;
	font-size:0.8em;
}
.item h3 {
	font-size:0.8em;
	color:#666666;
	margin:0%;
	line-height:0.5em;
}
.item p {
	padding:5%;
	background-color:#CCCCCC;
	color:#666666;
	border-radius:0.5em;
}
input {
	display:none;
}
</style>
<body>
<!-- audio -->
<header>
	<audio controls>
	  <source src="assets/music.wav" type="audio/wav">
	</audio>
</header>

<!-- reactions -->
<div class="sidebar">
	<input value="0-0"></input>
	<div id="reactions"></div>
</div>

<!-- score page-->
<div class="page" id="page1">
</div>

</body>
<script>

formatTime = d3.format(",.1f");
var measure;
var beat;
var ref = document.querySelector('input');
var watch = "same";

//mobile view
if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
    page=document.querySelectorAll('.page');
    for(i=0;i<page.length;i++){
    	page[i].style.height="120vh";
    }
};

// run functions
getScore();
d3.csv('data/timestamps.csv')
	.then(function(data) {
		getMusic(data);
	})
	.catch(function(error){
	})

function loadReactions() {
	d3.json('https://raw.githubusercontent.com/3milychu/music-vis/master/data/moment_all.json')
	.then(function(data){
		getReactions(data);
	})
	.catch(function(error){

	})
}

audio = document.querySelector('audio');
audio.onclick=function() {
	console.log("clear")
	target=document.querySelector('#reactions');
	target.html="";
}

// load music
function getMusic(data) {
	hover(1);
	music = document.querySelector('audio')
	setInterval(function () {
	    time = formatTime(music.currentTime);
		filter = data.filter(function(d){
	    	return (formatTime(d.timestamp).indexOf(time) === 0);
		 })
		if(filter.length==1){
			reset();
			label = filter[0]['img'];
			hover(label);
			scrollTo(label);
			measure = filter[0]['measure'].toString();
			beat = filter[0]['beat'].toString();
			if(ref.value!=measure+"-"+beat) {
				ref.value= measure+"-"+beat;
				watch = "changed";
			} else {
				watch ="same"
			}
			loadReactions();
		} 
	}, 30);
}

// get reactions
function getReactions(data){
	reactions = document.querySelector('#reactions');
	if(watch =="changed") {
		console.log("changed")
		add= data.filter(function(d){
    	return ((d.MOM_STARTBAR == measure) && (d.MOM_STARTBEAT ==beat));
		 })
		remove= data.filter(function(d){
	    	return ((d.MOM_ENDBAR == measure) && (d.MOM_ENDBEAT ==beat));
		 })
		if(add.length!=0){
			for (i=0;i<add.length;i++){
				comment = add[i]['MOM1CHAR'];
				id = add[i]['comment_id'];
				div = document.createElement('div');
				div.setAttribute("class","item")
				div.setAttribute('id',id);
				h3 = document.createElement('h3');
				h3.innerHTML=add[i]['role'];
				p = document.createElement('p');
				p.innerHTML="'"+comment+"'";
				label = document.createElement('label');
				// getCategory(add);
				// label.innerHTML=category;
				// category.setAttribute('class',category);
				div.appendChild(h3);
				div.appendChild(p);
				// div.appendChild(label);
				reactions.prepend(div);
			}
		}
		if(remove.length!=0){
			console.log(remove);
			for(j=0;j<remove.length;j++){
				id=remove[j]['comment_id']
				console.log(id);
				target = document.getElementById(id);
				console.log(target);
				target.remove();
			}	
		}
	};
}
// helper functions to highlight played moment in score and scroll to it in window
function reset() {
	overlays = document.querySelectorAll('.overlay');
	for(i=0;i<overlays.length;i++){
		overlays[i].style.opacity="0"
	}
}

function hover(img){
	target = document.querySelector('#page-holder'+img)
	overlay = target.querySelector('.overlay');
	overlay.style.opacity="0.5"
}

function scrollTo(img){
	target = document.querySelector('#page-holder'+img);
	target.scrollIntoViewIfNeeded();
}

//calculate which measure each beat falls under
function getScore() {
	measures=[1];
	measure_start=1
	for(i=1;i<=16;i++){
		measure_start=measure_start+4;
		measures.push(measure_start);
	}
	console.log(measures);
	for(i=1;i<61;i++){
		target=document.querySelector('#page1');
		width=window.innerWidth*.70;
		height=window.innerHeight*4;
		div = document.createElement('div');
		div.setAttribute("class","page-holder");
		div.setAttribute("id","page-holder"+i);
		overlay=document.createElement('div');
		overlay.setAttribute("class","overlay");
		img = document.createElement('img');
		img.src="assets/page1/"+i+".png";
		if(i<13){
			div.style.height=height/6+"px";
		}else if (i>44){
			div.style.height=height/9.5+"px";
		} else {
			div.style.height=height/13+"px";
		}
		div.appendChild(img);
		div.appendChild(overlay);
		target.appendChild(div);
	}
}

</script>
</html>